<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawConnect - Stray Animal Rescue Platform</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="header">
            üêæ PawConnect - Stray Animal Rescue Platform
        </div>
        
        <div class="main-content">
            <!-- Location Status -->
            <div id="locationStatus" class="location-status loading">
                <div id="locationText">üìç Getting your location...</div>
            </div>
            
            <!-- Interactive Map -->
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <!-- Controls Section -->
            <div class="controls-section">
                <button id="reportStrayBtn" class="report-button">
                    üêï Report a Stray Animal
                </button>
                <button id="viewReportsBtn" class="report-button" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">
                    üìã View Recent Reports
                </button>
            </div>
            
            <!-- Recent Stray Reports -->
            <div id="strayReports" class="stray-reports" style="display: none;">
                <h3>üêæ Recent Stray Reports</h3>
                <div id="reportsList"></div>
            </div>
        </div>
    </div>

    <!-- Report Stray Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üêï Report a Stray Animal</h2>
            
            <div id="reportForm">
                <div class="form-section">
                    <div class="icon">üì∑</div>
                    <div class="content">
                        <div class="label">Upload Photo</div>
                        <input type="file" id="photoInput" class="input" accept="image/*" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="icon">üìç</div>
                    <div class="content">
                        <div class="label">Location</div>
                        <input type="text" id="locationInput" class="input" placeholder="Click 'Use My Location' to auto-fill" readonly>
                        <button id="useLocationBtn" class="report-button" style="margin-top: 10px; padding: 10px 20px; font-size: 14px;">
                            üìç Use My Location
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="icon">üìù</div>
                    <div class="content">
                        <div class="label">Description</div>
                        <textarea id="descriptionInput" class="input" placeholder="Describe the animal, condition, behavior, etc." rows="3" required></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="icon">üè•</div>
                    <div class="content">
                        <div class="label">Select Nearby Shelter</div>
                        <div id="shelterSelection">
                            <p>Loading nearby shelters...</p>
                        </div>
                    </div>
                </div>
                
                <button id="submitReportBtn" class="submit-button" disabled>
                    Submit Report
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let userLocation = null;
        let selectedShelter = null;
        let strayReports = [];
        let shelters = [
            {
                id: 1,
                name: "BARC Houston",
                address: "3200 Carr St, Houston, TX 77026",
                phone: "(713) 229-7300",
                coords: [29.7604, -95.3698],
                capacity: 50
            },
            {
                id: 2,
                name: "Friends For Life",
                address: "107 E 22nd St, Houston, TX 77008",
                phone: "(713) 863-9835",
                coords: [29.7984, -95.4019],
                capacity: 30
            },
            {
                id: 3,
                name: "Houston Pets Alive",
                address: "2800 Antoine Dr, Houston, TX 77092",
                phone: "(713) 862-3863",
                coords: [29.8018, -95.4565],
                capacity: 25
            },
            {
                id: 4,
                name: "SPCA of Texas - Houston",
                address: "900 Portway Dr, Houston, TX 77024",
                phone: "(713) 869-7722",
                coords: [29.7849, -95.4565],
                capacity: 40
            }
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            getCurrentLocation();
            setupEventListeners();
            loadStrayReports();
        });

        // Initialize map
        function initializeMap() {
            // Default to Houston, TX
            map = L.map('map').setView([29.7604, -95.3698], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add shelter markers
            addShelterMarkers();
        }

        // Add shelter markers to map
        function addShelterMarkers() {
            shelters.forEach(shelter => {
                const shelterIcon = L.divIcon({
                    className: 'shelter-marker',
                    html: 'üè•',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                L.marker(shelter.coords, { icon: shelterIcon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>${shelter.name}</strong><br>
                        ${shelter.address}<br>
                        üìû ${shelter.phone}<br>
                        Capacity: ${shelter.capacity} animals
                    `);
            });
        }

        // Get user's current location
        function getCurrentLocation() {
            const locationStatus = document.getElementById('locationStatus');
            const locationText = document.getElementById('locationText');
            
            if (navigator.geolocation) {
                locationText.innerHTML = '<span class="loading-spinner"></span> Getting your location...';
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update map view
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        
                        // Add user location marker
                        const userIcon = L.divIcon({
                            className: 'user-marker',
                            html: 'üìç',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12]
                        });
                        
                        L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                            .addTo(map)
                            .bindPopup('Your Location');
                        
                        // Update location status
                        locationStatus.className = 'location-status success';
                        locationText.innerHTML = `‚úÖ Location found: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
                        
                        // Add stray report markers
                        addStrayReportMarkers();
                    },
                    function(error) {
                        locationStatus.className = 'location-status error';
                        locationText.innerHTML = '‚ùå Unable to get location. Please enable location services.';
                        console.error('Geolocation error:', error);
                    }
                );
            } else {
                locationStatus.className = 'location-status error';
                locationText.innerHTML = '‚ùå Geolocation not supported by this browser.';
            }
        }

        // Add stray report markers to map
        function addStrayReportMarkers() {
            strayReports.forEach((report, index) => {
                const pawIcon = L.divIcon({
                    className: 'paw-marker',
                    html: 'üêæ',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                });
                
                L.marker([report.lat, report.lng], { icon: pawIcon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>Stray Animal Report</strong><br>
                        ${report.description}<br>
                        <small>Reported: ${new Date(report.timestamp).toLocaleDateString()}</small>
                    `);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Report stray button
            document.getElementById('reportStrayBtn').addEventListener('click', openReportModal);
            
            // View reports button
            document.getElementById('viewReportsBtn').addEventListener('click', toggleReportsView);
            
            // Modal close
            document.querySelector('.close').addEventListener('click', closeReportModal);
            
            // Use location button
            document.getElementById('useLocationBtn').addEventListener('click', useCurrentLocation);
            
            // Submit report button
            document.getElementById('submitReportBtn').addEventListener('click', submitReport);
            
            // Photo input change
            document.getElementById('photoInput').addEventListener('change', validateForm);
            
            // Description input change
            document.getElementById('descriptionInput').addEventListener('input', validateForm);
        }

        // Open report modal
        function openReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            loadNearbyShelters();
        }

        // Close report modal
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            resetReportForm();
        }

        // Load nearby shelters
        function loadNearbyShelters() {
            const shelterSelection = document.getElementById('shelterSelection');
            
            if (!userLocation) {
                shelterSelection.innerHTML = '<p>‚ùå Location required to find nearby shelters</p>';
                return;
            }
            
            shelterSelection.innerHTML = '<h4>Select a shelter to send this report to:</h4><div class="shelter-grid"></div>';
            const shelterGrid = shelterSelection.querySelector('.shelter-grid');
            
            shelters.forEach(shelter => {
                const distance = calculateDistance(userLocation.lat, userLocation.lng, shelter.coords[0], shelter.coords[1]);
                const shelterCard = document.createElement('div');
                shelterCard.className = 'shelter-card';
                shelterCard.innerHTML = `
                    <h4>${shelter.name}</h4>
                    <p>${shelter.address}</p>
                    <p>üìû ${shelter.phone}</p>
                    <p class="distance">üìç ${distance.toFixed(1)} miles away</p>
                `;
                
                shelterCard.addEventListener('click', () => selectShelter(shelter, shelterCard));
                shelterGrid.appendChild(shelterCard);
            });
        }

        // Select shelter
        function selectShelter(shelter, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.shelter-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new shelter
            cardElement.classList.add('selected');
            selectedShelter = shelter;
            validateForm();
        }

        // Use current location
        function useCurrentLocation() {
            if (userLocation) {
                document.getElementById('locationInput').value = `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
                validateForm();
            } else {
                alert('Location not available. Please try again.');
            }
        }

        // Validate form
        function validateForm() {
            const photo = document.getElementById('photoInput').files[0];
            const description = document.getElementById('descriptionInput').value.trim();
            const submitBtn = document.getElementById('submitReportBtn');
            
            if (photo && description && selectedShelter) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // Submit report
        function submitReport() {
            const photo = document.getElementById('photoInput').files[0];
            const description = document.getElementById('descriptionInput').value.trim();
            const location = document.getElementById('locationInput').value;
            
            if (!photo || !description || !selectedShelter) {
                alert('Please fill in all required fields and select a shelter.');
                return;
            }
            
            // Create new report
            const newReport = {
                id: Date.now(),
                photo: URL.createObjectURL(photo),
                description: description,
                location: location,
                lat: userLocation.lat,
                lng: userLocation.lng,
                shelter: selectedShelter.name,
                timestamp: new Date().toISOString()
            };
            
            // Add to reports array
            strayReports.unshift(newReport);
            
            // Update map
            addStrayReportMarkers();
            
            // Update reports list
            updateReportsList();
            
            // Show success message
            showSuccessMessage(`Report submitted successfully to ${selectedShelter.name}!`);
            
            // Close modal
            closeReportModal();
        }

        // Show success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.controls-section'));
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Reset report form
        function resetReportForm() {
            document.getElementById('reportForm').reset();
            selectedShelter = null;
            document.getElementById('submitReportBtn').disabled = true;
        }

        // Toggle reports view
        function toggleReportsView() {
            const reportsDiv = document.getElementById('strayReports');
            const btn = document.getElementById('viewReportsBtn');
            
            if (reportsDiv.style.display === 'none') {
                reportsDiv.style.display = 'block';
                btn.textContent = 'üìã Hide Reports';
                updateReportsList();
            } else {
                reportsDiv.style.display = 'none';
                btn.textContent = 'üìã View Recent Reports';
            }
        }

        // Update reports list
        function updateReportsList() {
            const reportsList = document.getElementById('reportsList');
            
            if (strayReports.length === 0) {
                reportsList.innerHTML = '<p>No stray reports yet. Be the first to report a stray animal!</p>';
                return;
            }
            
            reportsList.innerHTML = strayReports.map(report => `
                <div class="stray-report-item">
                    <img src="${report.photo}" alt="Stray animal">
                    <div class="stray-report-info">
                        <h4>Stray Animal Report</h4>
                        <p><strong>Description:</strong> ${report.description}</p>
                        <p><strong>Location:</strong> ${report.location}</p>
                        <p><strong>Sent to:</strong> ${report.shelter}</p>
                        <p><strong>Reported:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // Load stray reports (from localStorage for demo)
        function loadStrayReports() {
            const saved = localStorage.getItem('pawconnect-reports');
            if (saved) {
                strayReports = JSON.parse(saved);
            }
        }

        // Save stray reports to localStorage
        function saveStrayReports() {
            localStorage.setItem('pawconnect-reports', JSON.stringify(strayReports));
        }

        // Calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Save reports when they change
        setInterval(saveStrayReports, 1000);
    </script>
</body>
</html>